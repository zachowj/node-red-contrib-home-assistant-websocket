<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/node-red-contrib-home-assistant-websocket/favicon.ico" size="32x32"><link rel="icon" href="/node-red-contrib-home-assistant-websocket/icon.svg" type="image/svg+xml"><title>Change node | node-red-contrib-home-assistant-websocket</title><meta name="description" content="A suite of nodes that seamlessly integrates Home Assistant with Node-RED">
    <link rel="preload" href="/node-red-contrib-home-assistant-websocket/assets/style-SuLB5pJw.css" as="style"><link rel="stylesheet" href="/node-red-contrib-home-assistant-websocket/assets/style-SuLB5pJw.css">
    <link rel="modulepreload" href="/node-red-contrib-home-assistant-websocket/assets/app-CrEJ5uQ_.js"><link rel="modulepreload" href="/node-red-contrib-home-assistant-websocket/assets/change-node.html-bYcFXZJd.js">
    <link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/FAQ.html-dBqOPXtG.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-DVwmbTUE.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/action.html-YZzx3Zz9.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/breaking-changes.html-B7zthbJE.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/conditionals.html-BzLCkdD6.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/development.html-3h4URyv9.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/diagnostics.html-BYJAqAoo.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/documentation.html-Q7YAJTDx.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/first-automation.html-CVqiUGEd.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-BCx9gxBt.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/migration.html-t-uVACj6.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/mustache-templates.html-DmCNTm-m.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/output-properties.html-tWtUAAkT.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/actionable-notifications-subflow-for-android.html-66G2v8bl.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/check-if-an-entity-was-turned-on-in-the-last-24-hours.html-DtYOxg7F.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/events-by-label.html-BT74JZst.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/expiration-date-monitor.html--ToU_uJV.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/get-state_changed-events-based-on-area.html-CjlwfKY-.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/holiday-lights-scheduler-and-demo-mode-for-wled.html-s-zSWapB.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-BwVkdRho.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/motion-triggered-light.html-uLt-2g_J.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/play-jellyfin-show-using-sentence-node.html-D1s76JKr.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/saving-and-restoring-states.html-CfWZJ1qS.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/starting-flow-after-home-assistant-restart.html-WKIAVq6g.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/sun-events.html-D5DbVzdN.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/using-date-and-time-entities-to-trigger-flows.html-DPY83DnV.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/vacation-mode.html-CCqc6c6d.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/API.html-TGKNeKMJ.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/action.html-lFYsuYIV.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/binary-sensor.html-CMm4PGlU.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/button.html-BBO4Oplf.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/config-server.html-C_ZnLW2G.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/current-state.html-BP8HaWcQ.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/device-config.html-DSeIVsF1.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/device.html-C2BwcQuE.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/entity-config.html-DTaIki5g.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/entity.html-BpNWDa17.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/events-all.html-CtPXV6sz.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/events-calendar.html-027AYUJV.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/events-state.html-CcVBq-Ti.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/fire-event.html-B4n3_MOh.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/get-entities.html-CqwBQHLA.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/get-history.html-DbOJ0mOG.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-CK5SRMC_.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/number.html-G2Vf5_5X.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/poll-state.html-C6KKyJaF.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/render-template.html-BukSjLQt.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/select.html-CWrHa24S.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/sensor.html-BP-AV0hS.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/sentence.html-CWttIXWt.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/switch.html-DFoldtbb.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/tag.html-BJx-rjO1.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/text.html-BOkk1nGG.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/time-entity.html-FRlK4Og5.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/time.html-BI1OHqXZ.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/trigger-state.html-DCW5LWXp.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/update-config.html-Cdx35HDQ.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/wait-until.html-DcSGxffE.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/webhook.html-Cr2P_uNI.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/zone.html-BY4bS2S7.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-CJv6V_Bm.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/exposed-nodes.html-uEjBsMim.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-w4QuZKkG.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-C49nuvQR.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/jsonata-primer.html-Zww3ACqU.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/action.html-CnNX1kE9.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/current-state.html-DUQ_5_VB.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/events-state.html-Bl8hURue.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/functions.html-DATqTUc8.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/sensor.html-wESfQGz4.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/switch-node.html-bg3PYXmC.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/trigger-state.html-vCj3djjZ.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/index.html-D_9G-W-y.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/404.html-D1ZwbX4A.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/DocsOnly-vwQFyUB4.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/InfoPanelOnly-B4CsnA0i.js" as="script"><link rel="prefetch" href="/node-red-contrib-home-assistant-websocket/assets/Scrubber-BxNAkqv3.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/node-red-contrib-home-assistant-websocket/"><img class="vp-site-logo" src="/node-red-contrib-home-assistant-websocket/logo-256.png" alt="node-red-contrib-home-assistant-websocket"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">node-red-contrib-home-assistant-websocket</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/guide/" aria-label="Guides"><!---->Guides<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/node/" aria-label="Nodes"><!---->Nodes<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/FAQ.html" aria-label="FAQ"><!---->FAQ<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/node-red-contrib-home-assistant-websocket/cookbook/" aria-label="Cookbook"><!---->Cookbook<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/scrubber/" aria-label="Scrubber"><!---->Scrubber<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/zachowj/node-red-contrib-home-assistant-websocket/discussions" aria-label="Discussions" rel="noopener noreferrer" target="_blank"><!---->Discussions<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://discord.gg/QNdsZgNBnU" aria-label="Discord" rel="noopener noreferrer" target="_blank"><!---->Discord<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/zachowj/node-red-contrib-home-assistant-websocket" aria-label="Github" rel="noopener noreferrer" target="_blank"><!---->Github<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/guide/" aria-label="Guides"><!---->Guides<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/node/" aria-label="Nodes"><!---->Nodes<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/FAQ.html" aria-label="FAQ"><!---->FAQ<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/node-red-contrib-home-assistant-websocket/cookbook/" aria-label="Cookbook"><!---->Cookbook<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/node-red-contrib-home-assistant-websocket/scrubber/" aria-label="Scrubber"><!---->Scrubber<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/zachowj/node-red-contrib-home-assistant-websocket/discussions" aria-label="Discussions" rel="noopener noreferrer" target="_blank"><!---->Discussions<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://discord.gg/QNdsZgNBnU" aria-label="Discord" rel="noopener noreferrer" target="_blank"><!---->Discord<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/zachowj/node-red-contrib-home-assistant-websocket" aria-label="Github" rel="noopener noreferrer" target="_blank"><!---->Github<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">Cookbook <!----></p><ul class="vp-sidebar-children" style=""><!--[--><li><p tabindex="0" class="vp-sidebar-item active">JSONata <!----></p><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/action.html" aria-label="Action Node JSONata Examples"><!---->Action Node JSONata Examples<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/change-node.html" aria-label="Change node"><!---->Change node<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/current-state.html" aria-label="Current State"><!---->Current State<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/events-state.html" aria-label="Events: state"><!---->Events: state<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/functions.html" aria-label="Other functions"><!---->Other functions<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/sensor.html" aria-label="Sensor"><!---->Sensor<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/switch-node.html" aria-label="Switch node"><!---->Switch node<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/trigger-state.html" aria-label="Trigger: state"><!---->Trigger: state<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/motion-triggered-light.html" aria-label="Motion Triggered Light"><!---->Motion Triggered Light<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/saving-and-restoring-states.html" aria-label="Saving and Restoring States"><!---->Saving and Restoring States<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/get-state_changed-events-based-on-area.html" aria-label="Get state_changed Events Based on Area"><!---->Get state_changed Events Based on Area<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/sun-events.html" aria-label="Turn Light On/Off with Sunset/Sunrise"><!---->Turn Light On/Off with Sunset/Sunrise<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/vacation-mode.html" aria-label="Vacation Mode"><!---->Vacation Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/expiration-date-monitor.html" aria-label="Expiration Date Monitor with notification"><!---->Expiration Date Monitor with notification<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/using-date-and-time-entities-to-trigger-flows.html" aria-label="Using Date and Time entities to trigger flows"><!---->Using Date and Time entities to trigger flows<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/check-if-an-entity-was-turned-on-in-the-last-24-hours.html" aria-label="Check if an entity was a certain state in the last 24 hours"><!---->Check if an entity was a certain state in the last 24 hours<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/starting-flow-after-home-assistant-restart.html" aria-label="Starting a flow after a Home Assistant restart"><!---->Starting a flow after a Home Assistant restart<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/holiday-lights-scheduler-and-demo-mode-for-wled.html" aria-label="Holiday lights scheduler and demo mode for WLED"><!---->Holiday lights scheduler and demo mode for WLED<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/node-red-contrib-home-assistant-websocket/cookbook/actionable-notifications-subflow-for-android.html" aria-label="Actionable Notifications Subflow for Android"><!---->Actionable Notifications Subflow for Android<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="change-node" tabindex="-1"><a class="header-anchor" href="#change-node"><span>Change node</span></a></h1><p><strong>Using JSONata for more complex tasks:</strong></p><p>Many automations can be coded using a simple JSONata expression at some convenient point in the flow, often directly within one of the WebSocket nodes. Where the data involved is a more complex structure, then JSONata is a powerful tool for manipulating JSON objects and arrays. Almost all computation can be achieved using JSONata in a Change node in place of using a Function node.</p><h2 id="read-a-person-state-history-for-the-past-week" tabindex="-1"><a class="header-anchor" href="#read-a-person-state-history-for-the-past-week"><span>Read a person state history for the past week</span></a></h2><p>Since Home Assistant stores state history for 10 days by default, it is possible to read historic state records. The <strong>Get History</strong> node can do this for any given entity, and using <em>relative time</em> it is easy to obtain an array of past <em>state-change</em> events.</p><p>There are no opportunities to use JSONata within the Get History node itself, however JSONata can be used both to setup the node parameters and to manipulate the returned array. In this example, JSONata is used extensively to:</p><ul><li>set the input parameters for the time period required</li><li>read the current entity state for &#39;now&#39; and the given entity ID</li><li>add an &#39;event&#39; for &#39;now&#39; and an &#39;event&#39; for the start history-period time</li><li>calculate the time interval between successive state changes to create &#39;event-periods&#39;</li><li>filter out any event periods less than, say, 50 minutes or for state &#39;unknown&#39;</li><li>compact any now sequential equal-state events into one longer period</li></ul><p>This returns a filtered array of entity states, with the time that state period started and the time it ended, and the duration in minutes. The requirement for extensive data processing here is due to the way &#39;person&#39; sensors report, giving rise to short periods of &#39;unknown&#39; or &#39;away&#39; because Wi-Fi signal or a smart phone has gone &#39;off-line&#39;.</p><p><img src="/node-red-contrib-home-assistant-websocket/assets/jsonata_7_1-BgEt8HOI.png" alt="screenshot"></p><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Process history data using JSONata in a change node&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;style&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;label&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#000000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;nodes&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;bd6511844a39ca08&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3d87bbb92fa35243&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;9a3ca494edc54a30&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3a4534cdc46ae67d&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;891ee0da3deec2c1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;27f0ecf4ea3dc24f&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;d5dc0b522463577a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2499</span><span class="token punctuation">,</span><span class="token property">&quot;w&quot;</span><span class="token operator">:</span><span class="token number">1312</span><span class="token punctuation">,</span><span class="token property">&quot;h&quot;</span><span class="token operator">:</span><span class="token number">122</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;bd6511844a39ca08&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;api-current-state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Get current state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;halt_if&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;halt_if_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;halt_if_compare&quot;</span><span class="token operator">:</span><span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entity_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;person.george&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;blockInputOverrides&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputProperties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload ~&gt; |$|{\&quot;entityId\&quot;: $entity().entity_id}|&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;entity&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;for&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forType&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forUnits&quot;</span><span class="token operator">:</span><span class="token string">&quot;minutes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;override_topic&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;state_location&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;override_payload&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entity_location&quot;</span><span class="token operator">:</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;override_data&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">350</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;9a3ca494edc54a30&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3d87bbb92fa35243&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;inject&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Set parameters&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;props&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;startAt&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v&quot;</span><span class="token operator">:</span><span class="token string">&quot;$fromMillis($millis()-(7*24*60*60000))&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;vt&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;repeat&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;crontab&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;once&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;onceDelay&quot;</span><span class="token operator">:</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token property">&quot;topic&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;payload&quot;</span><span class="token operator">:</span><span class="token string">&quot;{\&quot;relativeTime\&quot;: \&quot;1 week\&quot;\t}&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;payloadType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">160</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;bd6511844a39ca08&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;9a3ca494edc54a30&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;api-get-history&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Read history&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;startDate&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;endDate&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityIdType&quot;</span><span class="token operator">:</span><span class="token string">&quot;equals&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;useRelativeTime&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;relativeTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;flatten&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;outputType&quot;</span><span class="token operator">:</span><span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputLocationType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputLocation&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">530</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;3a4534cdc46ae67d&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a4534cdc46ae67d&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Get filtered state periods&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;pt&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\t/* FILTER parameters */\t    $fMins:=50;\t\t/* get current state from entity &#39;data&#39;, and set the &#39;last_changed&#39; to now */\t    $first:= data~&gt;|$|{\&quot;last_changed\&quot;: $now()}|;\t\t/* add this to far end of history payload array, then sort by reverse time order */\t    $x:=$append(payload, $first)^(&gt;last_changed,&gt;last_updated);\t\t/* copy the oldest state value, and add in as the first record at start of history */\t/* we now have a &#39;now&#39; and &#39;start of history&#39; record, even if payload was empty    */    \t    $x:=$append($x,{\&quot;state\&quot;: $x[0].state, \&quot;last_changed\&quot;: startAt});\t\t/* create array of state changes, with how long they have been in that state */\t/* remove any zero periods and unknown states FILTER OUT AS REQUIRED         */\t    $events:=$x#$i.(\t        $prior:= $i&gt;0 ? $x[$i-1] : {\&quot;first\&quot;: $now()};\t        {\&quot;index\&quot;: $i,\t         \&quot;state\&quot;: state,\t         \&quot;from\&quot;: last_changed,\t         \&quot;upto\&quot;: $prior.last_changed,\t         \&quot;dmins\&quot;: ($toMillis($prior.last_changed)-$toMillis(last_changed))/60000~&gt;$round(0)\t        }\t    )[dmins&gt;$fMins and state!=\&quot;unknown\&quot;];\t\t/* merge consecutive records with the same state into one longer period */\t/* get each event position as &#39;start - middle - end&#39; or &#39;only&#39;          */\t\t    $temp:=$events#$v.(\t        $back:= $v&lt;1 ? false : state = $events[$v-1].state;\t        $next:= state = $events[$v+1].state;\t        $position:=( $back ? ($next ? \&quot;middle\&quot; : \&quot;end\&quot;) : ($next ? \&quot;start\&quot; : \&quot;only\&quot;) );\t        $~&gt;|$|{\&quot;index\&quot;: $v, \&quot;position\&quot;: $position}|\t    );\t\t/* get start and end indexes, and zip into a sequence array of [start, end]  */\t/* map this array of sequences to an array of objects, one for each sequence */\t/* where the object is the combination of a run of the same state value      */\t\t    $chain:=$zip($temp[position=\&quot;start\&quot;].index, $temp[position=\&quot;end\&quot;].index);\t\t    $array:=$map($chain, function($item) {(\t        $recA:=$events[$item[0]];\t        $recB:=$events[$item[1]];\t        {\&quot;state\&quot;: $recA.state,\t        \&quot;from\&quot;: $recB.from,\t        \&quot;upto\&quot;:  $recA.upto,\t        \&quot;dmins\&quot;: ($toMillis($recA.upto)-$toMillis($recB.from))/60000~&gt;$round(0),\t        \&quot;position\&quot;: \&quot;merged\&quot;}\t        )\t    });\t\t/* combine the &#39;only&#39; single events with the now-merged sequences, and sort by time */\t    $append($temp[position=\&quot;only\&quot;], $array)^(&gt;from);\t\t)&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tot&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;reg&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">750</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;891ee0da3deec2c1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;27f0ecf4ea3dc24f&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;891ee0da3deec2c1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;State History Events&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">1200</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;27f0ecf4ea3dc24f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;When &#39;not home&#39; during the day&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;pt&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload[state=\&quot;not_home\&quot; and ($substringBefore(from,\&quot;T\&quot;) = $substringBefore(upto,\&quot;T\&quot;) ) ]&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tot&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;reg&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">930</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2580</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;d5dc0b522463577a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;d5dc0b522463577a&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Out during the day&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">1190</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2580</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre></div><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">(</span>
<span class="line">/* FILTER parameters */</span>
<span class="line">    $fMins:=50;</span>
<span class="line"></span>
<span class="line">/* get current state from entity &#39;data&#39;, and set the &#39;last_changed&#39; to now */</span>
<span class="line">    $first:= data~&gt;|$|{&quot;last_changed&quot;: $now()}|;</span>
<span class="line"></span>
<span class="line">/* add this to far end of history payload array, then sort by reverse time order */</span>
<span class="line">    $x:=$append(payload, $first)^(&gt;last_changed,&gt;last_updated);</span>
<span class="line"></span>
<span class="line">/* copy the oldest state value, and add in as the first record at start of history */</span>
<span class="line">/* we now have a &#39;now&#39; and &#39;start of history&#39; record, even if payload was empty    */</span>
<span class="line">    $x:=$append($x,{&quot;state&quot;: $x[0].state, &quot;last_changed&quot;: startAt});</span>
<span class="line"></span>
<span class="line">/* create array of state changes, with how long they have been in that state */</span>
<span class="line">/* remove any zero periods and unknown states FILTER OUT AS REQUIRED         */</span>
<span class="line">    $events:=$x#$i.(</span>
<span class="line">        $prior:= $i&gt;0 ? $x[$i-1] : {&quot;first&quot;: $now()};</span>
<span class="line">        {&quot;index&quot;: $i,</span>
<span class="line">         &quot;state&quot;: state,</span>
<span class="line">         &quot;from&quot;: last_changed,</span>
<span class="line">         &quot;upto&quot;: $prior.last_changed,</span>
<span class="line">         &quot;dmins&quot;: ($toMillis($prior.last_changed)-$toMillis(last_changed))/60000~&gt;$round(0)</span>
<span class="line">        }</span>
<span class="line">    )[dmins&gt;$fMins and state!=&quot;unknown&quot;];</span>
<span class="line"></span>
<span class="line">/* merge consecutive records with the same state into one longer period */</span>
<span class="line">/* get each event position as &#39;start - middle - end&#39; or &#39;only&#39;          */</span>
<span class="line"></span>
<span class="line">    $temp:=$events#$v.(</span>
<span class="line">        $back:= $v&lt;1 ? false : state = $events[$v-1].state;</span>
<span class="line">        $next:= state = $events[$v+1].state;</span>
<span class="line">        $position:=( $back ? ($next ? &quot;middle&quot; : &quot;end&quot;) : ($next ? &quot;start&quot; : &quot;only&quot;) );</span>
<span class="line">        $~&gt;|$|{&quot;index&quot;: $v, &quot;position&quot;: $position}|</span>
<span class="line">    );</span>
<span class="line"></span>
<span class="line">/* get start and end indexes, and zip into a sequence array of [start, end]  */</span>
<span class="line">/* map this array of sequences to an array of objects, one for each sequence */</span>
<span class="line">/* where the object is the combination of a run of the same state value      */</span>
<span class="line"></span>
<span class="line">    $chain:=$zip($temp[position=&quot;start&quot;].index, $temp[position=&quot;end&quot;].index);</span>
<span class="line"></span>
<span class="line">    $array:=$map($chain, function($item) {(</span>
<span class="line">        $recA:=$events[$item[0]];</span>
<span class="line">        $recB:=$events[$item[1]];</span>
<span class="line">        {&quot;state&quot;: $recA.state,</span>
<span class="line">        &quot;from&quot;: $recB.from,</span>
<span class="line">        &quot;upto&quot;:  $recA.upto,</span>
<span class="line">        &quot;dmins&quot;: ($toMillis($recA.upto)-$toMillis($recB.from))/60000~&gt;$round(0),</span>
<span class="line">        &quot;position&quot;: &quot;merged&quot;}</span>
<span class="line">        )</span>
<span class="line">    });</span>
<span class="line"></span>
<span class="line">/* combine the &#39;only&#39; single events with the now-merged sequences, and sort by time */</span>
<span class="line">    $append($temp[position=&quot;only&quot;], $array)^(&gt;from);</span>
<span class="line"></span>
<span class="line">)</span>
<span class="line"></span></code></pre></div><p><strong>Notes:</strong></p><p>The Inject node uses JSONata to initially create msg.payload as a data object, setting the relative time parameter for the Get History node, and also setting the timestamp for the effective start of this time period.</p><p>The Current State node uses JSONata in the output to retain msg.payload and also merge in the <em>entityId</em> using <code>$entity().entity_id</code>. This now sets msg.payload with the required input parameters for the Get History node (which therefore requires no UI settings). Full entity details are also captured in msg.data as usual.</p><div class="hint-container caution"><p class="hint-container-title">Caution</p><p>This example code has been tested but person sensors can go &#39;off line&#39; for long periods and the exact nature of the output data should be checked by experimentation.</p></div><h2 id="report-only-those-periods-when-not-home-during-the-day" tabindex="-1"><a class="header-anchor" href="#report-only-those-periods-when-not-home-during-the-day"><span>Report only those periods when <em>&#39;not home&#39;</em> during the day</span></a></h2><p>Once state history has been manipulated like this into an event-array, it is easy to ask questions, such as &quot;how many times has this person been away this week?&quot;</p><p>The question &quot;when was this person away during the day?&quot; for example, can be answered by filtering the state event array, to look for &#39;not home&#39; and for the event period (both start and end) to be entirely on the same date.</p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">payload[state=&quot;not_home&quot; and ($substringBefore(from,&quot;T&quot;) = $substringBefore(upto,&quot;T&quot;) ) ]</span>
<span class="line"></span></code></pre></div><p><strong>Note on history records:</strong></p><p>In asking for the history for the past 24 hours, the Get History node will return an array of all state change events that occurred within that time period. If the current state has been unchanged for the entire period requested, then an empty array will be returned.</p><p>To address this, the JSONata code here first adds a record for &#39;now&#39; with the current state. The code then finds the oldest state (which may well be the current &#39;now&#39; state just added) and adds that as a record for &#39;the start of the time period requested&#39; at that state. This ensures that the returned history event array is topped and tailed. The minimum state event array will therefore be <em>one</em> entry from <em>start of history request</em> to <em>now</em>, at the <em>current</em> state.</p><p><strong>Also see:</strong></p><ul><li><a class="route-link" href="/node-red-contrib-home-assistant-websocket/guide/jsonata/">JSONata guide</a></li><li><a class="route-link" href="/node-red-contrib-home-assistant-websocket/guide/jsonata/jsonata-primer.html">JSONata primer</a></li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link label" href="https://github.com/zachowj/node-red-contrib-home-assistant-websocket/edit/main/docs/cookbook/jsonata/change-node.md" aria-label="Help us improve this page!" rel="noopener noreferrer" target="_blank"><!--[--><svg class="edit-icon" viewbox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->Help us improve this page!<!----></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 37859597+zachowj@users.noreply.github.com">Jason</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/action.html" aria-label="Action Node JSONata Examples"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Action Node JSONata Examples</span></div></a><a class="route-link auto-link next" href="/node-red-contrib-home-assistant-websocket/cookbook/jsonata/current-state.html" aria-label="Current State"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Current State</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/node-red-contrib-home-assistant-websocket/assets/app-CrEJ5uQ_.js" defer></script>
  </body>
</html>
