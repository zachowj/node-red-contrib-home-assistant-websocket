import{_ as e,c as u,b as r,a as n,d as t,w as o,r as c,o as l,e as p}from"./app-CrEJ5uQ_.js";const i="/node-red-contrib-home-assistant-websocket/assets/jsonata_7_1-BgEt8HOI.png",k={};function q(d,s){const a=c("RouteLink");return l(),u("div",null,[s[2]||(s[2]=r('<h1 id="change-node" tabindex="-1"><a class="header-anchor" href="#change-node"><span>Change node</span></a></h1><p><strong>Using JSONata for more complex tasks:</strong></p><p>Many automations can be coded using a simple JSONata expression at some convenient point in the flow, often directly within one of the WebSocket nodes. Where the data involved is a more complex structure, then JSONata is a powerful tool for manipulating JSON objects and arrays. Almost all computation can be achieved using JSONata in a Change node in place of using a Function node.</p><h2 id="read-a-person-state-history-for-the-past-week" tabindex="-1"><a class="header-anchor" href="#read-a-person-state-history-for-the-past-week"><span>Read a person state history for the past week</span></a></h2><p>Since Home Assistant stores state history for 10 days by default, it is possible to read historic state records. The <strong>Get History</strong> node can do this for any given entity, and using <em>relative time</em> it is easy to obtain an array of past <em>state-change</em> events.</p><p>There are no opportunities to use JSONata within the Get History node itself, however JSONata can be used both to setup the node parameters and to manipulate the returned array. In this example, JSONata is used extensively to:</p><ul><li>set the input parameters for the time period required</li><li>read the current entity state for &#39;now&#39; and the given entity ID</li><li>add an &#39;event&#39; for &#39;now&#39; and an &#39;event&#39; for the start history-period time</li><li>calculate the time interval between successive state changes to create &#39;event-periods&#39;</li><li>filter out any event periods less than, say, 50 minutes or for state &#39;unknown&#39;</li><li>compact any now sequential equal-state events into one longer period</li></ul><p>This returns a filtered array of entity states, with the time that state period started and the time it ended, and the duration in minutes. The requirement for extensive data processing here is due to the way &#39;person&#39; sensors report, giving rise to short periods of &#39;unknown&#39; or &#39;away&#39; because Wi-Fi signal or a smart phone has gone &#39;off-line&#39;.</p><p><img src="'+i+`" alt="screenshot"></p><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Process history data using JSONata in a change node&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;style&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;label&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#000000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;nodes&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;bd6511844a39ca08&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3d87bbb92fa35243&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;9a3ca494edc54a30&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3a4534cdc46ae67d&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;891ee0da3deec2c1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;27f0ecf4ea3dc24f&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;d5dc0b522463577a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2499</span><span class="token punctuation">,</span><span class="token property">&quot;w&quot;</span><span class="token operator">:</span><span class="token number">1312</span><span class="token punctuation">,</span><span class="token property">&quot;h&quot;</span><span class="token operator">:</span><span class="token number">122</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;bd6511844a39ca08&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;api-current-state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Get current state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;halt_if&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;halt_if_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;halt_if_compare&quot;</span><span class="token operator">:</span><span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entity_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;person.george&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;blockInputOverrides&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputProperties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload ~&gt; |$|{\\&quot;entityId\\&quot;: $entity().entity_id}|&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;entity&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;for&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forType&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forUnits&quot;</span><span class="token operator">:</span><span class="token string">&quot;minutes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;override_topic&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;state_location&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;override_payload&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entity_location&quot;</span><span class="token operator">:</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;override_data&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">350</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;9a3ca494edc54a30&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3d87bbb92fa35243&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;inject&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Set parameters&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;props&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;startAt&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v&quot;</span><span class="token operator">:</span><span class="token string">&quot;$fromMillis($millis()-(7*24*60*60000))&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;vt&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;repeat&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;crontab&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;once&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;onceDelay&quot;</span><span class="token operator">:</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token property">&quot;topic&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;payload&quot;</span><span class="token operator">:</span><span class="token string">&quot;{\\&quot;relativeTime\\&quot;: \\&quot;1 week\\&quot;\\t}&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;payloadType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">160</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;bd6511844a39ca08&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;9a3ca494edc54a30&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;api-get-history&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Read history&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;startDate&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;endDate&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityIdType&quot;</span><span class="token operator">:</span><span class="token string">&quot;equals&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;useRelativeTime&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;relativeTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;flatten&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;outputType&quot;</span><span class="token operator">:</span><span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputLocationType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputLocation&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">530</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;3a4534cdc46ae67d&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a4534cdc46ae67d&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Get filtered state periods&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;pt&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t/* FILTER parameters */\\t    $fMins:=50;\\t\\t/* get current state from entity &#39;data&#39;, and set the &#39;last_changed&#39; to now */\\t    $first:= data~&gt;|$|{\\&quot;last_changed\\&quot;: $now()}|;\\t\\t/* add this to far end of history payload array, then sort by reverse time order */\\t    $x:=$append(payload, $first)^(&gt;last_changed,&gt;last_updated);\\t\\t/* copy the oldest state value, and add in as the first record at start of history */\\t/* we now have a &#39;now&#39; and &#39;start of history&#39; record, even if payload was empty    */    \\t    $x:=$append($x,{\\&quot;state\\&quot;: $x[0].state, \\&quot;last_changed\\&quot;: startAt});\\t\\t/* create array of state changes, with how long they have been in that state */\\t/* remove any zero periods and unknown states FILTER OUT AS REQUIRED         */\\t    $events:=$x#$i.(\\t        $prior:= $i&gt;0 ? $x[$i-1] : {\\&quot;first\\&quot;: $now()};\\t        {\\&quot;index\\&quot;: $i,\\t         \\&quot;state\\&quot;: state,\\t         \\&quot;from\\&quot;: last_changed,\\t         \\&quot;upto\\&quot;: $prior.last_changed,\\t         \\&quot;dmins\\&quot;: ($toMillis($prior.last_changed)-$toMillis(last_changed))/60000~&gt;$round(0)\\t        }\\t    )[dmins&gt;$fMins and state!=\\&quot;unknown\\&quot;];\\t\\t/* merge consecutive records with the same state into one longer period */\\t/* get each event position as &#39;start - middle - end&#39; or &#39;only&#39;          */\\t\\t    $temp:=$events#$v.(\\t        $back:= $v&lt;1 ? false : state = $events[$v-1].state;\\t        $next:= state = $events[$v+1].state;\\t        $position:=( $back ? ($next ? \\&quot;middle\\&quot; : \\&quot;end\\&quot;) : ($next ? \\&quot;start\\&quot; : \\&quot;only\\&quot;) );\\t        $~&gt;|$|{\\&quot;index\\&quot;: $v, \\&quot;position\\&quot;: $position}|\\t    );\\t\\t/* get start and end indexes, and zip into a sequence array of [start, end]  */\\t/* map this array of sequences to an array of objects, one for each sequence */\\t/* where the object is the combination of a run of the same state value      */\\t\\t    $chain:=$zip($temp[position=\\&quot;start\\&quot;].index, $temp[position=\\&quot;end\\&quot;].index);\\t\\t    $array:=$map($chain, function($item) {(\\t        $recA:=$events[$item[0]];\\t        $recB:=$events[$item[1]];\\t        {\\&quot;state\\&quot;: $recA.state,\\t        \\&quot;from\\&quot;: $recB.from,\\t        \\&quot;upto\\&quot;:  $recA.upto,\\t        \\&quot;dmins\\&quot;: ($toMillis($recA.upto)-$toMillis($recB.from))/60000~&gt;$round(0),\\t        \\&quot;position\\&quot;: \\&quot;merged\\&quot;}\\t        )\\t    });\\t\\t/* combine the &#39;only&#39; single events with the now-merged sequences, and sort by time */\\t    $append($temp[position=\\&quot;only\\&quot;], $array)^(&gt;from);\\t\\t)&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tot&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;reg&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">750</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;891ee0da3deec2c1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;27f0ecf4ea3dc24f&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;891ee0da3deec2c1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;State History Events&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">1200</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;27f0ecf4ea3dc24f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;When &#39;not home&#39; during the day&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;pt&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload[state=\\&quot;not_home\\&quot; and ($substringBefore(from,\\&quot;T\\&quot;) = $substringBefore(upto,\\&quot;T\\&quot;) ) ]&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tot&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;reg&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">930</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2580</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;d5dc0b522463577a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;d5dc0b522463577a&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1997b594da7d37b1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Out during the day&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">1190</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">2580</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre></div><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">(</span>
<span class="line">/* FILTER parameters */</span>
<span class="line">    $fMins:=50;</span>
<span class="line"></span>
<span class="line">/* get current state from entity &#39;data&#39;, and set the &#39;last_changed&#39; to now */</span>
<span class="line">    $first:= data~&gt;|$|{&quot;last_changed&quot;: $now()}|;</span>
<span class="line"></span>
<span class="line">/* add this to far end of history payload array, then sort by reverse time order */</span>
<span class="line">    $x:=$append(payload, $first)^(&gt;last_changed,&gt;last_updated);</span>
<span class="line"></span>
<span class="line">/* copy the oldest state value, and add in as the first record at start of history */</span>
<span class="line">/* we now have a &#39;now&#39; and &#39;start of history&#39; record, even if payload was empty    */</span>
<span class="line">    $x:=$append($x,{&quot;state&quot;: $x[0].state, &quot;last_changed&quot;: startAt});</span>
<span class="line"></span>
<span class="line">/* create array of state changes, with how long they have been in that state */</span>
<span class="line">/* remove any zero periods and unknown states FILTER OUT AS REQUIRED         */</span>
<span class="line">    $events:=$x#$i.(</span>
<span class="line">        $prior:= $i&gt;0 ? $x[$i-1] : {&quot;first&quot;: $now()};</span>
<span class="line">        {&quot;index&quot;: $i,</span>
<span class="line">         &quot;state&quot;: state,</span>
<span class="line">         &quot;from&quot;: last_changed,</span>
<span class="line">         &quot;upto&quot;: $prior.last_changed,</span>
<span class="line">         &quot;dmins&quot;: ($toMillis($prior.last_changed)-$toMillis(last_changed))/60000~&gt;$round(0)</span>
<span class="line">        }</span>
<span class="line">    )[dmins&gt;$fMins and state!=&quot;unknown&quot;];</span>
<span class="line"></span>
<span class="line">/* merge consecutive records with the same state into one longer period */</span>
<span class="line">/* get each event position as &#39;start - middle - end&#39; or &#39;only&#39;          */</span>
<span class="line"></span>
<span class="line">    $temp:=$events#$v.(</span>
<span class="line">        $back:= $v&lt;1 ? false : state = $events[$v-1].state;</span>
<span class="line">        $next:= state = $events[$v+1].state;</span>
<span class="line">        $position:=( $back ? ($next ? &quot;middle&quot; : &quot;end&quot;) : ($next ? &quot;start&quot; : &quot;only&quot;) );</span>
<span class="line">        $~&gt;|$|{&quot;index&quot;: $v, &quot;position&quot;: $position}|</span>
<span class="line">    );</span>
<span class="line"></span>
<span class="line">/* get start and end indexes, and zip into a sequence array of [start, end]  */</span>
<span class="line">/* map this array of sequences to an array of objects, one for each sequence */</span>
<span class="line">/* where the object is the combination of a run of the same state value      */</span>
<span class="line"></span>
<span class="line">    $chain:=$zip($temp[position=&quot;start&quot;].index, $temp[position=&quot;end&quot;].index);</span>
<span class="line"></span>
<span class="line">    $array:=$map($chain, function($item) {(</span>
<span class="line">        $recA:=$events[$item[0]];</span>
<span class="line">        $recB:=$events[$item[1]];</span>
<span class="line">        {&quot;state&quot;: $recA.state,</span>
<span class="line">        &quot;from&quot;: $recB.from,</span>
<span class="line">        &quot;upto&quot;:  $recA.upto,</span>
<span class="line">        &quot;dmins&quot;: ($toMillis($recA.upto)-$toMillis($recB.from))/60000~&gt;$round(0),</span>
<span class="line">        &quot;position&quot;: &quot;merged&quot;}</span>
<span class="line">        )</span>
<span class="line">    });</span>
<span class="line"></span>
<span class="line">/* combine the &#39;only&#39; single events with the now-merged sequences, and sort by time */</span>
<span class="line">    $append($temp[position=&quot;only&quot;], $array)^(&gt;from);</span>
<span class="line"></span>
<span class="line">)</span>
<span class="line"></span></code></pre></div><p><strong>Notes:</strong></p><p>The Inject node uses JSONata to initially create msg.payload as a data object, setting the relative time parameter for the Get History node, and also setting the timestamp for the effective start of this time period.</p><p>The Current State node uses JSONata in the output to retain msg.payload and also merge in the <em>entityId</em> using <code>$entity().entity_id</code>. This now sets msg.payload with the required input parameters for the Get History node (which therefore requires no UI settings). Full entity details are also captured in msg.data as usual.</p><div class="hint-container caution"><p class="hint-container-title">Caution</p><p>This example code has been tested but person sensors can go &#39;off line&#39; for long periods and the exact nature of the output data should be checked by experimentation.</p></div><h2 id="report-only-those-periods-when-not-home-during-the-day" tabindex="-1"><a class="header-anchor" href="#report-only-those-periods-when-not-home-during-the-day"><span>Report only those periods when <em>&#39;not home&#39;</em> during the day</span></a></h2><p>Once state history has been manipulated like this into an event-array, it is easy to ask questions, such as &quot;how many times has this person been away this week?&quot;</p><p>The question &quot;when was this person away during the day?&quot; for example, can be answered by filtering the state event array, to look for &#39;not home&#39; and for the event period (both start and end) to be entirely on the same date.</p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">payload[state=&quot;not_home&quot; and ($substringBefore(from,&quot;T&quot;) = $substringBefore(upto,&quot;T&quot;) ) ]</span>
<span class="line"></span></code></pre></div><p><strong>Note on history records:</strong></p><p>In asking for the history for the past 24 hours, the Get History node will return an array of all state change events that occurred within that time period. If the current state has been unchanged for the entire period requested, then an empty array will be returned.</p><p>To address this, the JSONata code here first adds a record for &#39;now&#39; with the current state. The code then finds the oldest state (which may well be the current &#39;now&#39; state just added) and adds that as a record for &#39;the start of the time period requested&#39; at that state. This ensures that the returned history event array is topped and tailed. The minimum state event array will therefore be <em>one</em> entry from <em>start of history request</em> to <em>now</em>, at the <em>current</em> state.</p><p><strong>Also see:</strong></p>`,23)),n("ul",null,[n("li",null,[t(a,{to:"/guide/jsonata/"},{default:o(()=>[...s[0]||(s[0]=[p("JSONata guide",-1)])]),_:1})]),n("li",null,[t(a,{to:"/guide/jsonata/jsonata-primer.html"},{default:o(()=>[...s[1]||(s[1]=[p("JSONata primer",-1)])]),_:1})])])])}const h=e(k,[["render",q],["__file","change-node.html.vue"]]),g=JSON.parse(`{"path":"/cookbook/jsonata/change-node.html","title":"Change node","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Read a person state history for the past week","slug":"read-a-person-state-history-for-the-past-week","link":"#read-a-person-state-history-for-the-past-week","children":[]},{"level":2,"title":"Report only those periods when 'not home' during the day","slug":"report-only-those-periods-when-not-home-during-the-day","link":"#report-only-those-periods-when-not-home-during-the-day","children":[]}],"git":{"updatedTime":1719788083000,"contributors":[{"name":"Jason","email":"37859597+zachowj@users.noreply.github.com","commits":2}]},"filePathRelative":"cookbook/jsonata/change-node.md"}`);export{h as comp,g as data};
