import{_ as e,c as u,b as r,a as n,d as t,w as o,r as c,o as l,e as p}from"./app-CrEJ5uQ_.js";const i="/node-red-contrib-home-assistant-websocket/assets/jsonata_3_1-DCTS43SR.png",k="/node-red-contrib-home-assistant-websocket/assets/jsonata_value_example-DJn_j-gH.png",q="/node-red-contrib-home-assistant-websocket/assets/jsonata_boolean_example-DbjCVol3.png",d={};function g(y,s){const a=c("RouteLink");return l(),u("div",null,[s[2]||(s[2]=r('<h1 id="events-state" tabindex="-1"><a class="header-anchor" href="#events-state"><span>Events: state</span></a></h1><p>The <strong>Events: state</strong> node receives state change <em>events</em> for one or more entities, and will output a message in response. The message output can be optionally controlled by a test condition on the state value, and also by a test on the length of time the state remains at that value. Both the <em>state test condition</em> and the <em>state time duration</em> can use JSONata. This node can also provide <em>output message properties</em>, again with the ability to use JSONata.</p><p><img src="'+i+`" alt="screenshot"></p><p>Here are three examples, showing how to use JSONata to perform <strong>If-State conditional tests</strong>, and to build <strong>output properties</strong>.</p><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Events: state node - respond to state changes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;style&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;label&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#000000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;nodes&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;445466367c412014&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e27b6ee2807af2eb&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;4583560d5089575d&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;24ed76ccd4da5975&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;266eadf86abd6481&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;27857c0c670e452b&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e2ba71699db68b1a&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1d9b8adce4f77e4e&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;a9b23a3911f5ef89&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">919</span><span class="token punctuation">,</span><span class="token property">&quot;w&quot;</span><span class="token operator">:</span><span class="token number">592</span><span class="token punctuation">,</span><span class="token property">&quot;h&quot;</span><span class="token operator">:</span><span class="token number">342</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;445466367c412014&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a - JSONata builds conditional test value&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;info&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">960</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;e27b6ee2807af2eb&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;server-state-changed&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Switch was on for less than 3 minutes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;exposeAsEntityConfig&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token string">&quot;switch\\\\.[a-z][0-9]&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityIdType&quot;</span><span class="token operator">:</span><span class="token string">&quot;regex&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputInitially&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifState&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t    $new:=$entity();\\t    $old:=$prevEntity();\\t    $mins:=($toMillis($new.last_changed)-$toMillis($old.last_changed))/60000~&gt;$round(0);\\t    $new.state=\\&quot;off\\&quot; and $old.state=\\&quot;on\\&quot; and $mins&lt;3\\t)&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifStateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifStateOperator&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputOnlyOnStateChange&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;for&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forType&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forUnits&quot;</span><span class="token operator">:</span><span class="token string">&quot;minutes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateNull&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateUnknown&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateUnavailable&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignoreCurrentStateUnknown&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignoreCurrentStateUnavailable&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputProperties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;\\&quot;Device \\&quot; &amp; $entity().attributes.friendly_name &amp; \\&quot; has been on for less than 3 minutes\\&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;triggerId&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1140</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;4583560d5089575d&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;4583560d5089575d&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Flow trigger&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">490</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1140</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;24ed76ccd4da5975&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;server-state-changed&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Motion between dawn and dusk&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;exposeAsEntityConfig&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token string">&quot;motion&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityIdType&quot;</span><span class="token operator">:</span><span class="token string">&quot;substring&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputInitially&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifState&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t    $ismotion:= $entity().state=\\&quot;on\\&quot;;\\t\\t    $dawn:=$entities(&#39;sensor.sun_next_dawn&#39;).state;\\t    $dusk:=$entities(&#39;sensor.sun_next_dusk&#39;).state;\\t    $date:=$entities(&#39;sensor.date_time_utc&#39;).state~&gt;$substringBefore(\\&quot;,\\&quot;);\\t\\t    $isdawn:= $date=$substringBefore($dawn,\\&quot;T\\&quot;);\\t    $isdusk:= $date!=$substringBefore($dusk,\\&quot;T\\&quot;);\\t    \\t    $ismotion and ($isdawn or $isdusk)\\t)&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifStateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifStateOperator&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputOnlyOnStateChange&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;for&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forType&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forUnits&quot;</span><span class="token operator">:</span><span class="token string">&quot;minutes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateNull&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateUnknown&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateUnavailable&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignoreCurrentStateUnknown&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignoreCurrentStateUnavailable&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputProperties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t    $ismotion:= $entity().state=\\&quot;on\\&quot;;\\t\\t    $dawn:=$entities(&#39;sensor.sun_next_dawn&#39;).state;\\t    $dusk:=$entities(&#39;sensor.sun_next_dusk&#39;).state;\\t    $date:=$entities(&#39;sensor.date_time_utc&#39;).state~&gt;$substringBefore(\\&quot;,\\&quot;);\\t\\t    $isdawn:= $date=$substringBefore($dawn,\\&quot;T\\&quot;);\\t    $isdusk:= $date!=$substringBefore($dusk,\\&quot;T\\&quot;);\\t    \\t    $fire:= $ismotion and ($isdawn or $isdusk);\\t\\t    {\\&quot;motion\\&quot;: $ismotion,\\t    \\&quot;dawn\\&quot;: $dawn,\\t    \\&quot;dusk\\&quot;: $dusk,\\t    \\&quot;date\\&quot;: $date,\\t    \\&quot;isdawn\\&quot;: $isdawn,\\t    \\&quot;isdusk\\&quot;: $isdusk,\\t    \\&quot;fire\\&quot;: $fire\\t    }\\t)&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;eventData&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;triggerId&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1220</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;266eadf86abd6481&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;266eadf86abd6481&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Dawn or Dusk&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload.isdawn ? \\&quot;Before Dawn\\&quot; : payload.isdusk ? \\&quot;After Dusk\\&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1220</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;27857c0c670e452b&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;server-state-changed&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;exposeAsEntityConfig&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token string">&quot;motion&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityIdType&quot;</span><span class="token operator">:</span><span class="token string">&quot;substring&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputInitially&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifState&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t    $time:=$entities(&#39;sensor.time&#39;).state;\\t    $append([\\&quot;on\\&quot;], $time&lt;\\&quot;08:30\\&quot; or $time&gt;\\&quot;17:30\\&quot; ? [\\&quot;off\\&quot;]);\\t)    &quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifStateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ifStateOperator&quot;</span><span class="token operator">:</span><span class="token string">&quot;includes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;outputOnlyOnStateChange&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;for&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forType&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;forUnits&quot;</span><span class="token operator">:</span><span class="token string">&quot;seconds&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateNull&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateUnknown&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignorePrevStateUnavailable&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignoreCurrentStateUnknown&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;ignoreCurrentStateUnavailable&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputProperties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;entityState&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;eventData&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;valueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;triggerId&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1020</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;1d9b8adce4f77e4e&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;e2ba71699db68b1a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;e2ba71699db68b1a&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Condition false&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1040</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1d9b8adce4f77e4e&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Condition true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload=\\&quot;on\\&quot; ? \\&quot;Motion at \\&quot; &amp; $now(&#39;[H]:[m]&#39;) : \\&quot;end\\&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">980</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;a9b23a3911f5ef89&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;35b892e153bb5bc0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;3b - JSONata builds conditional Boolean&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;info&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1100</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre></div><h3 id="providing-a-conditional-test-value-jsonata-expression-as-a-value" tabindex="-1"><a class="header-anchor" href="#providing-a-conditional-test-value-jsonata-expression-as-a-value"><span>Providing a conditional test value (JSONata expression as a <em>value</em>)</span></a></h3><p><strong>Example:</strong> Respond to motion events for both &quot;on&quot; (start of motion detection) all day, and also &quot;off&quot; (end of motion detection) but only outside of 08:30 to 17:30.</p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">(</span>
<span class="line">    $time:=$entities(&#39;sensor.time&#39;).state;</span>
<span class="line">    $append([&quot;on&quot;], $time&lt;&quot;08:30&quot; or $time&gt;&quot;17:30&quot; ? [&quot;off&quot;]);</span>
<span class="line">)</span>
<span class="line"></span></code></pre></div><p>When the <strong>If State</strong> option is chosen with a <em>conditional</em> (not JSONata) the condition expects a <em>value</em> to test against. The result of the JSONata expression is the final line in the code block. This creates an array containing just [&quot;on&quot;] or if the time is before 08:30 or after 17:30, an array of [&quot;on&quot;, &quot;off&quot;]. The motion sensor entity state will be compared with this array value using the inclusive condition &#39;in&#39;.</p><p><img src="`+k+'" alt="screenshot"></p><p>This JSONata uses the Date-Time integration sensor to obtain the local time. The <a href="https://www.home-assistant.io/integrations/time_date/" target="_blank" rel="noopener noreferrer">Time &amp; Date Integration</a> should be added to the configuration file, and then the time sensor will return the current local time.</p><h3 id="conditional-test-jsonata-expression-as-a-boolean-result" tabindex="-1"><a class="header-anchor" href="#conditional-test-jsonata-expression-as-a-boolean-result"><span>Conditional test (JSONata expression as a <em>Boolean result</em>)</span></a></h3><p><strong>Example:</strong> Switch has just been turned off, and was previously on for less than three minutes.</p><p>When the <strong>If State</strong> option is chosen with <em>JSONata</em> (not a conditional) then the right hand side must be a JSONata expression that returns a Boolean value of either <code>true</code> or <code>false</code>. When true the &quot;If State&quot; test is successful (the message is output from the top exit) when false the test fails (the message is output from the lower exit).</p><p><img src="'+q+`" alt="screenshot"></p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">(</span>
<span class="line">    $new:=$entity();</span>
<span class="line">    $old:=$prevEntity();</span>
<span class="line">    $mins:=($toMillis($new.last_changed)-$toMillis($old.last_changed))/60000~&gt;$round(0);</span>
<span class="line">    $new.state=&quot;off&quot; and $old.state=&quot;on&quot; and $mins&lt;3</span>
<span class="line">)</span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>In all the WebSocket nodes, the <code>$entity()</code> function will return an object for the entity that is the subject of the node. For the <strong>Event:</strong> nodes, the <code>$entity()</code> return is for the <em>current</em> or new state, and an additional <code>$prevEntity()</code> function will return a similar object for the <em>previous</em> state. Use of both functions allows JSONata expressions to work with and compare the triggering state change.</p><p><strong>Example:</strong> Motion has been detected before dawn or after dusk.</p><p>Here JSONata is again used to generate a Boolean result for the If State test. The expression return is the final line in the code block, which tests for motion and either before dawn or after dusk. The use of &#39;or&#39; here is an example of how JSONata can extend logic testing since the <strong>Trigger state</strong> node conditions can only group conditions as AND logic.</p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">(</span>
<span class="line">    $ismotion:= $entity().state=&quot;on&quot;;</span>
<span class="line"></span>
<span class="line">    $dawn:=$entities(&#39;sensor.sun_next_dawn&#39;).state;</span>
<span class="line">    $dusk:=$entities(&#39;sensor.sun_next_dusk&#39;).state;</span>
<span class="line">    $date:=$entities(&#39;sensor.date_time_utc&#39;).state~&gt;$substringBefore(&quot;,&quot;);</span>
<span class="line"></span>
<span class="line">    $isdawn:= $date=$substringBefore($dawn,&quot;T&quot;);</span>
<span class="line">    $isdusk:= $date!=$substringBefore($dusk,&quot;T&quot;);</span>
<span class="line"></span>
<span class="line">    $ismotion and ($isdawn or $isdusk)</span>
<span class="line">)</span>
<span class="line"></span></code></pre></div><p>The <em>Sun</em> integration in Home Assistant provides &#39;next<em>dawn&#39; and &#39;next_dusk&#39; sensors, with a date-time string value in UTC. Since the _next</em> dawn will be for today before dawn, but will be for tomorrow after dawn, and similarly the <em>next</em> dusk will be for today before dusk, but for tomorrow after dusk, it is possible to compare just the date parts of the UTC timestamps, so as to determine if the current time is before or after either dawn or dusk.</p><h3 id="creating-output-properties" tabindex="-1"><a class="header-anchor" href="#creating-output-properties"><span>Creating <em>output</em> properties</span></a></h3><p>To extend this last example, JSONata is used to generate an <strong>output object</strong>. Note that there is no internal connection between the two JSONata expressions, so all the values have to be recalculated as required.</p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">(</span>
<span class="line">    $ismotion:= $entity().state=&quot;on&quot;;</span>
<span class="line"></span>
<span class="line">    $dawn:=$entities(&#39;sensor.sun_next_dawn&#39;).state;</span>
<span class="line">    $dusk:=$entities(&#39;sensor.sun_next_dusk&#39;).state;</span>
<span class="line">    $date:=$entities(&#39;sensor.date_time_utc&#39;).state~&gt;$substringBefore(&quot;,&quot;);</span>
<span class="line"></span>
<span class="line">    $isdawn:= $date=$substringBefore($dawn,&quot;T&quot;);</span>
<span class="line">    $isdusk:= $date!=$substringBefore($dusk,&quot;T&quot;);</span>
<span class="line"></span>
<span class="line">    $fire:= $ismotion and ($isdawn or $isdusk);</span>
<span class="line"></span>
<span class="line">    {&quot;motion&quot;: $ismotion,</span>
<span class="line">    &quot;dawn&quot;: $dawn,</span>
<span class="line">    &quot;dusk&quot;: $dusk,</span>
<span class="line">    &quot;date&quot;: $date,</span>
<span class="line">    &quot;isdawn&quot;: $isdawn,</span>
<span class="line">    &quot;isdusk&quot;: $isdusk,</span>
<span class="line">    &quot;fire&quot;: $fire</span>
<span class="line">    }</span>
<span class="line">)</span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="or-conditional-for-the-events-state-node" tabindex="-1"><a class="header-anchor" href="#or-conditional-for-the-events-state-node"><span>OR conditional for the Events: state node</span></a></h3><p>The <strong>Trigger: state</strong> node is great if you have several conditions you want to check for but it doesn&#39;t allow use of OR conditions. Using a JSONata expression with an <em>Event: state</em> node will allow you to fill this gap.</p><p><strong>Example:</strong> Motion sensor at the front door triggers, and have a text to speech notification be sent if at least one person is home.</p><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">$entity().state = &quot;on&quot; and (</span>
<span class="line">   $entities(&quot;person.person1&quot;).state = &quot;home&quot; or $entities(&quot;person.person2&quot;).state = &quot;home&quot;</span>
<span class="line">)</span>
<span class="line"></span></code></pre></div><p><strong>Also see:</strong></p>`,29)),n("ul",null,[n("li",null,[t(a,{to:"/guide/jsonata/"},{default:o(()=>[...s[0]||(s[0]=[p("JSONata guide",-1)])]),_:1})]),n("li",null,[t(a,{to:"/guide/jsonata/jsonata-primer.html"},{default:o(()=>[...s[1]||(s[1]=[p("JSONata primer",-1)])]),_:1})])])])}const m=e(d,[["render",g],["__file","events-state.html.vue"]]),f=JSON.parse('{"path":"/cookbook/jsonata/events-state.html","title":"Events: state","lang":"en-US","frontmatter":{},"headers":[{"level":3,"title":"Providing a conditional test value (JSONata expression as a value)","slug":"providing-a-conditional-test-value-jsonata-expression-as-a-value","link":"#providing-a-conditional-test-value-jsonata-expression-as-a-value","children":[]},{"level":3,"title":"Conditional test (JSONata expression as a Boolean result)","slug":"conditional-test-jsonata-expression-as-a-boolean-result","link":"#conditional-test-jsonata-expression-as-a-boolean-result","children":[]},{"level":3,"title":"Creating output properties","slug":"creating-output-properties","link":"#creating-output-properties","children":[]},{"level":3,"title":"OR conditional for the Events: state node","slug":"or-conditional-for-the-events-state-node","link":"#or-conditional-for-the-events-state-node","children":[]}],"git":{"updatedTime":1719788083000,"contributors":[{"name":"Jason","email":"37859597+zachowj@users.noreply.github.com","commits":2}]},"filePathRelative":"cookbook/jsonata/events-state.md"}');export{m as comp,f as data};
